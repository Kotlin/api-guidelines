<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">  <meta charset="UTF-8">   <meta name="built-on" content="${builtOn}">   <title>Predictabilityâ€”API guidelines</title><script id="virtual-toc-data" type="application/json">[{"id":"use-sealed-interfaces","level":0,"title":"Use sealed interfaces","anchor":"#use-sealed-interfaces"},{"id":"hide-implementations-with-sealed-classes","level":0,"title":"Hide implementations with sealed classes","anchor":"#hide-implementations-with-sealed-classes"},{"id":"validate-your-inputs-and-state","level":0,"title":"Validate your inputs and state","anchor":"#validate-your-inputs-and-state"},{"id":"validate-with-the-require-function","level":1,"title":"Validate with the require() function","anchor":"#validate-with-the-require-function"},{"id":"validate-with-the-check-function","level":1,"title":"Validate with the check() function","anchor":"#validate-with-the-check-function"},{"id":"avoid-arrays-in-public-signatures","level":0,"title":"Avoid arrays in public signatures","anchor":"#avoid-arrays-in-public-signatures"},{"id":"avoid-varargs","level":0,"title":"Avoid varargs","anchor":"#avoid-varargs"},{"id":"what-s-next","level":0,"title":"What\u0027s next?","anchor":"#what-s-next"}]</script>     <link href="api-guidelines/app/app.css%3F_ijt=4o6hbqa37mp6mvmer7umfmoiot.css" rel="stylesheet">   <link rel="shortcut icon" href="https://resources.jetbrains.com/storage/ui/favicons/favicon.ico" type="image/x-icon" sizes="16x16 32x32"/><link rel="apple-touch-icon" sizes="57x57" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="https://resources.jetbrains.com/storage/ui/favicons/apple-touch-icon-180x180.png"/><link rel="mask-icon" href="https://resources.jetbrains.com/storage/ui/favicons/apple-mask-icon.svg" color="black"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content="${ogMetaImage}"><!-- Open Graph --><meta property="og:title" content="Predictability - Help | API guidelines"/><meta property="og:description" content=""/><meta property="og:image" content="${ogMetaImage}"/><meta property="og:site_name" content="API guidelines Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="${ogUrl}"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="${ogTwitter}"><meta name="twitter:title" content="Predictability - Help | API guidelines"><meta name="twitter:description" content=""><meta name="twitter:creator" content="${ogTwitter}"><meta name="twitter:image:src" content="${ogMetaImage}"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "${ogUrl}#webpage", "url": "${ogUrl}", "name": "Predictability - Help | API guidelines", "description": "", "image": "${ogMetaImage}", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "${ogUrlRoot}#website", "url": "${ogUrlRoot}", "name": "API guidelines Help" }</script><!-- End Schema.org --></head>    <body data-id="jvm-api-guidelines-predictability" data-main-title="Predictability" data-article-props="{&quot;microFormat&quot;:[],&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs=""  data-edit-url="https://github.com/Kotlin/api-guidelines/edit/main/docs/topics/jvm-api-guidelines-predictability.md"  >  <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>API guidelines  Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select class="select _shortcuts" height="1" id="switch-shortcuts">      </select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="jvm-api-guidelines-predictability" id="jvm-api-guidelines-predictability.md"  >Predictability</h1><p id="db16" >This chapter contains the following recommendations:</p> <ul class="list _ul" id="db1a"   ><li class="list__item" id="db1e" ><a href="jvm-api-guidelines-predictability.html#use-sealed-interfaces" id="db22"  >Use sealed interfaces</a></li> <li class="list__item" id="db28" ><a href="jvm-api-guidelines-predictability.html#hide-implementations-with-sealed-classes" id="db2c"  >Hide implementations with sealed classes</a></li> <li class="list__item" id="db32" ><a href="jvm-api-guidelines-predictability.html#validate-your-inputs-and-state" id="db36"  >Validate your inputs and state</a> <ul class="list _ul" id="db3c"   ><li class="list__item" id="db40" ><a href="jvm-api-guidelines-predictability.html#validate-with-the-require-function" id="db44"  >Validate with the require() function</a></li> <li class="list__item" id="db4a" ><a href="jvm-api-guidelines-predictability.html#validate-with-the-check-function" id="db4e"  >Validate with the check() function</a></li></ul></li> <li class="list__item" id="db54" ><a href="jvm-api-guidelines-predictability.html#avoid-arrays-in-public-signatures" id="db58"  >Avoid arrays in public signatures</a></li> <li class="list__item" id="db5e" ><a href="jvm-api-guidelines-predictability.html#avoid-varargs" id="db62"  >Avoid varargs</a></li></ul> <section class="chapter" >  <h2 id="use-sealed-interfaces" data-toc="jvm-api-guidelines-predictability#use-sealed-interfaces" >Use sealed interfaces</h2><p id="db6d" >Interfaces in your API are usually necessary when you need to have an abstraction from implementation. If you have to use interfaces, consider using <a href="https://kotlinlang.org/docs/sealed-classes.html" data-external="true" id="db71" rel="noopener noreferrer" >sealed interfaces</a>. This is especially important if you don't want API users to extend your hierarchy.</p> <aside data-type="warning" class="prompt" data-title="" id="db77"><p id="db7c" >Remember that adding a new implementation to a sealed interface immediately makes a user's code invalid.</p></aside> <p id="db80" >For example, JSON types can be of six types: object, array, number, string, boolean, and null. Creating a generic <code class="code " id="db84"  >interface JsonElement</code> can result in errors because a user can accidentally define a new implementation of  <code class="code " id="db88"  >JsonElement</code>, which could break your code. Instead, you can make <code class="code " id="db8c"  >interface JsonElement</code> <i id="db90"  class="" >sealed</i> and add an implementation for each type:</p> <div class="code-block" data-lang="kotlin" id="db98"       >  sealed interface JsonElement

class JsonNumber(val value: Number) : JsonElement
class JsonObject(val values: Map&lt;String, JsonElement&gt;) : JsonElement
class JsonArray(val values: List&lt;JsonElement&gt;) : JsonElement
class JsonBoolean(val value: Boolean) : JsonElement
class JsonString(val value: String) : JsonElement
object JsonNull : JsonElement
  </div> <p id="db9d" >This approach helps you avoid mistakes on both the library and client side.</p> <p id="dba1" >The key benefit of using sealed classes comes into play when you use them in a <code class="code " id="dba5"  >when</code> expression. If it's possible to verify that the statement covers all cases, you don't need to add an <code class="code " id="dba9"  >else</code> clause to the statement:</p> <div class="code-block" data-lang="kotlin" id="dbb1"       >  fun processJson(json: JsonElement) = when (json) {
    is JsonNumber -&gt; { /* Process as a number */ }
    is JsonObject -&gt; { /* Process as an object */ }
    is JsonArray -&gt; { /* Process as an array */ }
    is JsonBoolean -&gt; { /* Process as a boolean */ }
    is JsonString -&gt; { /* Process as a string */ }
    is JsonNull -&gt; { /* Process as null */ }
    // `else` clause is not required because all the cases are covered
}
  </div>  </section><section class="chapter" >  <h2 id="hide-implementations-with-sealed-classes" data-toc="jvm-api-guidelines-predictability#hide-implementations-with-sealed-classes" >Hide implementations with sealed classes</h2><p id="dbbb" >If you have a sealed interface in your API, it doesn't mean that you should expose all its implementations in your API too. Minimizing is always better. If you need to avoid leaky abstractions or want to disallow API users to extend your interfaces, consider using sealed classes or interfaces with your internal implementations too.</p> <p id="dbbf" >For example, a library working with different databases can have an interface of a database response like this:</p> <div class="code-block" data-lang="kotlin" id="dbc7"       >  sealed interface DBResponse {
    operator fun &lt;T&gt; get(columnName: String): Sequence&lt;T&gt;
}
  </div> <p id="dbcc" >Exposing this interface implementation &ndash; for example, <code class="code " id="dbd0"  >SQLiteResponse</code> or <code class="code " id="dbd4"  >MongoResponse</code> &ndash; to API users is a <b id="dbd8" class=""  >leaky abstraction</b>, and it complicates support of this API. In such a library, you might handle only your implementations of <code class="code " id="dbdc"  >DBResponse</code>. If, at some moment, a user puts their implementation of <code class="code " id="dbe0"  >DBResponse</code> into a library's method accepting responses, it can cause an error. Using sealed interfaces and classes can protect you from this.</p>  </section><section class="chapter" >  <h2 id="validate-your-inputs-and-state" data-toc="jvm-api-guidelines-predictability#validate-your-inputs-and-state" >Validate your inputs and state</h2><section class="chapter" >  <h3 id="validate-with-the-require-function" data-toc="jvm-api-guidelines-predictability#validate-with-the-require-function" >Validate with the require() function</h3><p id="dbee" >It's possible to misuse an API. To help your users work with your API correctly, you should validate inputs and the internal state as early as possible with the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/require.html" data-external="true" id="dbf2" rel="noopener noreferrer" >require()</a> function.</p> <p id="dbf8" >For example, this is a simple library function that saves some users to some external API:</p> <div class="code-block" data-lang="kotlin" id="dc00"       >  fun saveUser(username: String, password: String) {
    api.saveUser(User(username, password))
}
  </div> <p id="dc05" >You should perform some validation on its arguments to make sure that everything behaves as expected. For example, check that <code class="code " id="dc09"  >username</code> is unique and not empty even if you have already defined these constraints in your database:</p> <div class="code-block" data-lang="kotlin" id="dc11"       >  fun saveUser(username: String, password: String) {
    require(username.isNotBlank()) { &quot;Username should not be blank&quot; }
    require(api.usernameAvailable(username)) { &quot;Username $username is already taken&quot; }
    require(password.isNotBlank()) { &quot;Password should not be blank&quot; }
    require(password.length &gt; 6) { &quot;Password should contain at least 7 letters&quot; }
    require(
        /* Some complex check */
    ) { &quot;...&quot; }

    api.saveUser(User(username, password))
}
  </div> <p id="dc16" >This way you ensure that your user doesn't need to dig into complex stack traces that lead to the database. In the case of an exception, it is an <code class="code " id="dc1a"  >IllegalArgumentException</code> with a meaningful message, not a generic database exception.</p> <aside data-type="tip" class="prompt" data-title="" id="dc1e"><p id="dc23" >If you have implemented input validation, you should also document these checks.</p></aside>  </section><section class="chapter" >  <h3 id="validate-with-the-check-function" data-toc="jvm-api-guidelines-predictability#validate-with-the-check-function" >Validate with the check() function</h3><p id="dc2c" >The same recommendations apply to checking the internal state. The most obvious example is <code class="code " id="dc30"  >InputStream</code> because you can't read from an already closed input stream.</p> <p id="dc34" >Consider the class <code class="code " id="dc38"  >InputStream</code> with a <code class="code " id="dc3c"  >readByte()</code> method and its usage:</p> <div class="code-block" data-lang="kotlin" id="dc44"       >  class InputStream : Closeable {
    private var open = true
    fun readByte(): Byte { /* Read and return one byte */
    }
    override fun close() {
        // Dispose of the underlying resource
        open = false
    }
}

fun readTwoBytes(inputStream: InputStream): Pair&lt;Byte, Byte&gt; {
    val first = inputStream.use { it.readByte() }
    val second = inputStream.readByte()
    return Pair(first, second)
}
  </div> <p id="dc49" >The method <code class="code " id="dc4d"  >readTwoBytes()</code> has to throw an <code class="code " id="dc51"  >IllegalStateException</code> because <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.io/use.html" data-external="true" id="dc55" rel="noopener noreferrer" ><code class="code " id="dc5b"  >use{}</code></a> closes a <code class="code " id="dc5f"  >Closeable</code> input stream, and a user shouldn't be able to read from a closed stream. To implement this, modify the code of the <code class="code " id="dc63"  >readByte()</code> function:</p> <div class="code-block" data-lang="kotlin" id="dc6b"       >  fun readByte(): Byte {
    check(open) { &quot;Can't read from the already closed stream&quot; }
    // Read and return one byte
}
  </div> <p id="dc70" >In the example above, the <code class="code " id="dc74"  >check()</code> function is used, not <code class="code " id="dc78"  >require()</code>. These functions throw different exceptions: <code class="code " id="dc7c"  >require()</code> throws an <code class="code " id="dc80"  >IllegalArgumentException</code> while <code class="code " id="dc84"  >check()</code> throws an <code class="code " id="dc88"  >IllegalStateException</code>. This difference is important to know because it might become significant when debugging.</p>  </section>  </section><section class="chapter" >  <h2 id="avoid-arrays-in-public-signatures" data-toc="jvm-api-guidelines-predictability#avoid-arrays-in-public-signatures" >Avoid arrays in public signatures</h2><p id="dc91" >Arrays are always mutable, and Kotlin is built around safe &ndash;read-only or immutable&ndash; objects. If you have to use arrays in your API, copy them before passing them anywhere so that you can check that they have not been modified. As an alternative, use read-only and mutable collections according to your intentions. Generally, it is best to avoid using arrays and be very cautious if you need to use them.</p> <p id="dc95" >For example, enum classes in Kotlin have the <code class="code " id="dc99"  >values()</code> function that returns an array of all elements of the enum. If the array is not copied, a user is able to rewrite elements:</p> <div class="code-block" data-lang="kotlin" id="dca1"       >  enum class Test { A, B }

fun main() { Test.values()[0] = Test.B }
  </div> <p id="dca6" >If you cache values inside the enum, the cache will be corrupted after running the code above. If the values are not cached, it's an additional runtime overhead for each call of the <code class="code " id="dcaa"  >values()</code> function.</p>  </section><section class="chapter" >  <h2 id="avoid-varargs" data-toc="jvm-api-guidelines-predictability#avoid-varargs" >Avoid varargs</h2><p id="dcb3" >A <code class="code " id="dcb7"  >vararg</code> &ndash;<a href="https://kotlinlang.org/docs/functions.html#variable-number-of-arguments-varargs" data-external="true" id="dcbb" rel="noopener noreferrer" >variable number of arguments</a>&ndash; works as an array under the hood, but the array elements are passed individually to the function, not the whole array. This operation is costly because it's copying the same array repeatedly.</p> <p id="dcc1" >Consider this code:</p> <div class="code-block" data-lang="kotlin" id="jvm-api-guide-print-elements"       >  fun printElements(delimiter: String, vararg elements: String) {
    for (i in elements.indices) {
        print(elements[i])
        if (i &lt; elements.lastIndex) print(delimiter)
    }
}

fun printWithSpace(vararg elements: String) {
    printElements(&quot; &quot;, *elements)
}

fun main() {
    printWithSpace(&quot;x&quot;, &quot;y&quot;, &quot;z&quot;)
}
  </div> <p id="dcd2" >The <code class="code " id="dcd6"  >printElements()</code> function prints all strings from the <code class="code " id="dcda"  >vararg</code> argument <code class="code " id="dcde"  >elements</code> with a delimiter, and the <code class="code " id="dce2"  >printWithSpace()</code> function calls <code class="code " id="dce6"  >printElements()</code> with the delimiter defined as a space. The code looks innocent: you just pass elements from <code class="code " id="dcea"  >printWithSpace()</code> to <code class="code " id="dcee"  >printElements()</code>. Without the spread operator <code class="code " id="dcf2"  >*</code>, the code won't compile, but with it, the <b id="dcf6" class=""  >array is actually copied</b> before being passed to the <code class="code " id="dcfa"  >printElements()</code> function. The longer the chain is, the more copies that are created, and the bigger the unexpected memory overhead is.</p>  </section><section class="chapter" >  <h2 id="what-s-next" data-toc="jvm-api-guidelines-predictability#what-s-next" >What's next?</h2><p id="dd03" >Learn about API's:</p> <ul class="list _ul" id="dd07"   ><li class="list__item" id="dd0b" ><a href="jvm-api-guidelines-debuggability.html" id="dd0f"  >Debuggability</a></li> <li class="list__item" id="dd15" ><a href="jvm-api-guidelines-backward-compatibility.html" id="dd19"  >Backward compatibility</a></li></ul>  </section><div class="last-modified"> Last modified: 10 April 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">   </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="api-guidelines/app/app.js%3F_ijt=4o6hbqa37mp6mvmer7umfmoiot"></script></body></html>